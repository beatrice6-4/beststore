{% load static %}
<!DOCTYPE HTML>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="pragma" content="no-cache" />
<meta http-equiv="cache-control" content="max-age=604800" />
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<title>KIMBAKERY | One of the Biggest Online Shopping Platform</title>

<link href="{% static 'images/favicon.jpg' %}" rel="shortcut icon" type="image/x-icon">

<!-- jQuery -->
<script src="{% static 'js/jquery-2.0.0.min.js' %}" type="text/javascript"></script>

<!-- Bootstrap4 files-->
<script src="{% static 'js/bootstrap.bundle.min.js' %}" type="text/javascript"></script>
<link href="{% static 'css/bootstrap.css' %}" rel="stylesheet" type="text/css"/>

<!-- Font awesome 5 -->
<link href="{% static 'fonts/fontawesome/css/all.min.css' %}" type="text/css" rel="stylesheet">

<!-- custom style -->
<link href="{% static 'css/ui.css' %}" rel="stylesheet" type="text/css"/>
<link href="{% static 'css/responsive.css' %}" rel="stylesheet" media="only screen and (max-width: 1200px)" />

<link href="{% static 'css/custom.css' %}" rel="stylesheet" type="text/css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<!-- custom javascript -->
<script src="{% static 'js/script.js' %}" type="text/javascript"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="{% static 'js/jquery-3.3.1.min.js' %}" type="text/javascript"></script>

<style>
/* Loader Styles */
#loader-overlay {
  display: none;
  position: fixed;
  z-index: 9999;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(255,255,255,0.7);
}
.loader {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  width: 48px;
  height: 48px;
  border-radius: 50%;
  border-top: 4px solid hsl(246, 98%, 49%);
  border-right: 4px solid transparent;
  box-sizing: border-box;
  animation: rotation 1s linear infinite;
}
.loader::after {
  content: '';
  box-sizing: border-box;
  position: absolute;
  left: 0;
  top: 0;
  width: 48px;
  height: 48px;
  border-radius: 50%;
  border-left: 4px solid #FF3D00;
  border-bottom: 4px solid transparent;
  animation: rotation 0.5s linear infinite reverse;
}
@keyframes rotation {
  0% { transform: rotate(0deg);}
  100% { transform: rotate(360deg);}
}
</style>

<script type="text/javascript">
$(document).ready(function() {
    // Show loader on navigation
    $('a').on('click', function(e) {
        var href = $(this).attr('href');
        // Only show loader for real navigation, not anchors or JS links
        if (href && href.charAt(0) !== '#' && !$(this).attr('target')) {
            $('#loader-overlay').show();
        }
    });
    // Hide loader when page is loaded
    $(window).on('pageshow', function() {
        $('#loader-overlay').hide();
    });

    // Mpesa STK Push AJAX payment handler
    var stkForm = document.getElementById('stkpush-form');
    if (stkForm) {
        stkForm.addEventListener('submit', function(e) {
            e.preventDefault();
            // Show loader
            var loader = document.getElementById('loading-spinner');
            if (loader) loader.style.display = 'block';
            var resultDiv = document.getElementById('payment-result');
            if (resultDiv) resultDiv.innerHTML = '';

            var formData = new FormData(stkForm);

            fetch(stkForm.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (loader) loader.style.display = 'none';
                if (data.ResponseCode === "0") {
                    if (resultDiv) resultDiv.innerHTML =
                        '<div class="alert alert-success">STK Push sent! Please complete payment on your phone.</div>';
                } else if (data.error) {
                    if (resultDiv) resultDiv.innerHTML =
                        '<div class="alert alert-danger">' + data.error + '</div>';
                } else {
                    if (resultDiv) resultDiv.innerHTML =
                        '<div class="alert alert-warning">Unexpected response. Please try again.</div>';
                }
            })
            .catch(error => {
                if (loader) loader.style.display = 'none';
                if (resultDiv) resultDiv.innerHTML =
                    '<div class="alert alert-danger">Error processing payment. Please try again.</div>';
            });
        });
    }
});
</script>

</head>
<body>

  <!-- Loader Overlay -->
  <div id="loader-overlay">
    <span class="loader"></span>
  </div>

  <!-- navbar -->
  {% include 'includes/navbar.html' %}

  {% block content %}
  <!-- content -->
  {% endblock %}

  <!-- footer -->
  {% include 'includes/footer.html' %}
</body>
</html>