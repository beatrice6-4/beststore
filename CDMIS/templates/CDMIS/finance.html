{% extends 'gov.html' %}
{% load static %}
{% block content %}
<style>
    .finance-card {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 24px rgba(44,62,80,0.08);
        padding: 32px 24px;
        margin: 40px auto;
        max-width: 900px;
    }
    .finance-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 28px;
    }
    .finance-header h2 {
        color: #004080;
        font-weight: 700;
        margin: 0;
        font-size: 2rem;
        letter-spacing: 1px;
    }
    .download-btn {
        background: linear-gradient(90deg, #4e54c8 0%, #8f94fb 100%);
        border: none;
        color: #fff;
        font-weight: 600;
        border-radius: 24px;
        padding: 8px 28px;
        transition: background 0.2s;
        box-shadow: 0 2px 8px rgba(44,62,80,0.08);
        font-size: 1.08em;
    }
    .download-btn:hover {
        background: linear-gradient(90deg, #8f94fb 0%, #4e54c8 100%);
        color: #fff;
    }
    .finance-table {
        background: #fff;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 12px rgba(44,62,80,0.06);
        margin-bottom: 24px;
    }
    .finance-table thead th {
        background: #f3f3fa;
        color: #4e54c8;
        font-weight: 700;
        border-bottom: 2px solid #e0e0ef;
        font-size: 1.08em;
    }
    .finance-table tbody tr.date-row {
        background: #eafbe7;
        color: #2d7a2d;
        font-weight: 600;
    }
    .finance-table tbody tr.payment-row {
        background: #f7f8fa;
    }
    .finance-table tbody tr.payment-row:nth-of-type(even) {
        background: #f3f3fa;
    }
    .grand-total-card {
        background: linear-gradient(90deg, #4e54c8 0%, #8f94fb 100%);
        color: #fff;
        border-radius: 12px;
        padding: 18px 24px;
        font-size: 1.3em;
        font-weight: 700;
        text-align: center;
        box-shadow: 0 2px 12px rgba(44,62,80,0.06);
        margin-bottom: 24px;
    }
    .gov-logo {
        display: block;
        margin: 0 auto 18px auto;
        height: 80px;
    }
    @media (max-width: 700px) {
        .finance-card {
            padding: 16px 4px;
        }
        .finance-header h2 {
            font-size: 1.3rem;
        }
        .download-btn {
            padding: 8px 12px;
            font-size: 1em;
        }
        .grand-total-card {
            font-size: 1em;
            padding: 12px 8px;
        }
    }
</style>

<div class="finance-card">
    <img src="{% static 'images/gov.png' %}" alt="Logo" class="gov-logo">
    <div class="finance-header">
        <h2><i class="fa fa-coins me-2 text-success"></i> Financial Summary</h2>
        <button class="download-btn" onclick="printSelectedFinance()">
            <i class="fa fa-print"></i> Print Selected Dates
        </button>
    </div>

    <!-- Date selection form for CSV download and print -->
    <form method="post" id="datesForm" class="mb-4">
        {% csrf_token %}
        <div class="card p-3 mb-3">
            <h5><i class="fa fa-calendar-alt text-primary"></i> Download Finance Summary by Date</h5>
            <div class="row">
                {% for item in finance_list %}
                    <div class="col-md-3 col-6 mb-2">
                        <label>
                            <input type="checkbox" name="dates" value="{{ item.date }}">
                            {{ item.date }}
                        </label>
                    </div>
                {% endfor %}
            </div>
            <button type="submit" class="btn btn-success mt-2">
                <i class="fa fa-download"></i> Download Selected Dates Summary
            </button>
        </div>
    </form>

    <table class="table finance-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Group</th>
                    <th>Amount</th>
                </tr>
            </thead>
        </table>
    </table>
            </tr>
        </thead>
        <tbody>
            {% for item in finance_list %}
                <tr class="date-row">
                    <td colspan="3">
                        <i class="fa fa-calendar-alt text-success"></i>
                        <strong>{{ item.date }}</strong>
                        <span class="float-end" style="color:#2d7a2d;">
                            <i class="fa fa-sack-dollar"></i> Total: {{ item.date_total }}
                        </span>
                    </td>
                </tr>
                {% for payment in item.payments %}
                <tr class="payment-row">
                    <td></td>
                    <td><i class="fa fa-users text-primary"></i> {{ payment.group }}</td>
                    <td>Ksh. {{ payment.amount }}</td>
                </tr>
                {% endfor %}
            {% empty %}
                <tr><td colspan="3" class="text-center">No payments found.</td></tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="grand-total-card">
        <i class="fa fa-calculator me-2"></i>
        Grand Total: Ksh. {{ grand_total }}
    </div>
</div>

<script>
function printSelectedFinance() {
    // Get checked dates
    var checked = document.querySelectorAll('input[name="dates"]:checked');
    var selectedDates = Array.from(checked).map(function(cb) { return cb.value; });

    if (selectedDates.length === 0) {
        alert("Please select at least one date to print.");
        return;
    }

    // Prepare printable HTML
    var printable = '<div style="text-align:center; margin-bottom:20px;">' +
        '<img src="{% static "images/gov.png" %}" alt="Logo" style="height:80px;">' +
        '<h2 style="margin-top:10px;">Financial Summary</h2></div>' +
        '<table border="1" cellpadding="8" cellspacing="0" width="100%" style="border-collapse:collapse; margin-bottom:20px;">' +
        '<thead style="background:#eafbe7; color:#2d7a2d;"><tr><th>Date</th><th>Group</th><th>Amount</th></tr></thead><tbody>';

    var grandTotal = 0;

    {% for item in finance_list %}
        if (selectedDates.includes("{{ item.date }}")) {
            var dateTotal = {{ item.date_total }};
            grandTotal += dateTotal;
            printable += '<tr style="background:#eafbe7;"><td colspan="3"><strong>{{ item.date }}</strong> â€” <span style="color:#2d7a2d;">Total: {{ item.date_total }}</span></td></tr>';
            {% for payment in item.payments %}
                printable += '<tr><td></td><td>{{ payment.group }}</td><td>{{ payment.amount }}</td></tr>';
            {% endfor %}
        }
    {% endfor %}

    printable += '</tbody></table>';
    printable += '<table border="1" cellpadding="8" cellspacing="0" width="100%" style="border-collapse:collapse;">' +
        '<thead style="background:#eafbe7; color:#2d7a2d;"><tr><th>Grand Total</th></tr></thead>' +
        '<tbody><tr><td>' + grandTotal + '</td></tr></tbody></table>';

    var win = window.open('', '', 'height=900,width=1200');
    win.document.write('<html><head><title>Financial Summary</title>');
    win.document.write('<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">');
    win.document.write('<style>body{font-family:Segoe UI,Arial,sans-serif;} table{margin-bottom:24px;} th,td{padding:8px 10px;}</style>');
    win.document.write('</head><body>');
    win.document.write(printable);
    win.document.write('</body></html>');
    win.document.close();
    win.focus();
    win.print();
}
</script>
{% endblock %}